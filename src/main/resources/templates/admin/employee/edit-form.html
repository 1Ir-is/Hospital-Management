<!DOCTYPE html>
<html lang="vi"
      layout:decorate="~{admin/layout/layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chỉnh sửa Nhân viên</title>
    <style>
        .info-card, .form-card {
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            background: #f0f4ff;
            border: 1px solid #dbeafe;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .form-layout {
            display: flex;
            gap: 32px;
            align-items: flex-start;
        }

        .form-left,
        .form-right {
            flex: 1;
            min-width: 0;
        }

        .employee-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .employee-avatar {
            text-align: center;
        }

        .employee-avatar img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e9ecef;
        }

        .employee-id {
            font-size: 12px;
            color: #6c757d;
            margin-top: 8px;
            font-weight: 500;
        }

        .employee-details h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 20px;
        }

        .employee-details p {
            margin: 4px 0;
            color: #6c757d;
            font-size: 14px;
        }

        .employee-details i {
            width: 16px;
            margin-right: 8px;
            color: #007bff;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 16px;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .warning-box i {
            color: #ff9800;
            font-size: 18px;
        }

        .roles-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 8px;
        }

        .role-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .role-item input[type="checkbox"] {
            margin: 0;
        }

        .role-label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .role-label small {
            color: #6c757d;
            font-size: 12px;
        }

        .character-count {
            text-align: right;
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        .success-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #d4edda;
            color: #155724;
            padding: 16px 20px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .success-notification.show {
            transform: translateX(0);
        }

        .success-notification i {
            font-size: 18px;
            color: #28a745;
        }

        .employee-form {
            max-width: 100%;
            padding: 0 40px; /* hoặc 0 20px nếu cần sát hơn */
            box-sizing: border-box;
        }

    </style>
</head>
<body>
<div layout:fragment="main-content">
    <!-- Breadcrumb -->
    <nav class="breadcrumb-nav">
        <div class="breadcrumb">
            <a th:href="@{/admin}">Dashboard</a>
            <i class="fas fa-chevron-right"></i>
            <a th:href="@{/admin/employees}">Nhân viên</a>
            <i class="fas fa-chevron-right"></i>
            <span>Chỉnh sửa nhân viên</span>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-title-section">
                <h1 class="page-title">
                    <i class="fas fa-user-edit"></i>
                    Chỉnh sửa nhân viên
                </h1>
                <p class="page-subtitle">
                    Cập nhật thông tin nhân viên trong hệ thống
                </p>
            </div>
            <div class="page-actions">
                <a class="btn-secondary" th:href="@{/admin/employees}">
                    <i class="fas fa-arrow-left"></i>
                    Quay lại danh sách
                </a>
            </div>
        </div>
    </div>

    <!-- Employee Info Card -->
    <div class="info-card">
        <div class="employee-info">
            <div class="employee-avatar">
                <img alt="Avatar" id="avatarPreview" th:src="${employeeForm.avatar}"/>
                <div class="employee-id">ID: <span th:text="${employeeForm.id}">EMP001</span></div>
            </div>
            <div class="employee-details">
                <h3 th:text="${employeeForm.name}">Nguyễn Văn A</h3>
                <p><i class="fas fa-envelope"></i> <span th:text="${employeeForm.email}">nguyenvana@hospital.com</span>
                </p>
                <p><i class="fas fa-phone"></i> <span th:text="${employeeForm.phone}">0901234567</span></p>
            </div>
        </div>
        <div class="warning-box">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Lưu ý:</strong> Việc thay đổi thông tin nhân viên có thể ảnh hưởng đến việc đăng nhập và phân quyền
            của họ.
        </div>
    </div>

    <!-- Form Card -->
    <div class="form-card">
        <div class="form-header">
            <h2>Thông tin nhân viên</h2>
            <p>Cập nhật thông tin nhân viên bên dưới</p>
        </div>

        <form
                class="employee-form"
                id="employeeForm"
                method="post"
                th:action="@{'/admin/employees/edit/' + ${employeeForm.id}}"
                th:object="${employeeForm}"
        >
            <div class="form-layout">
                <!-- CỘT TRÁI: THÔNG TIN CÁ NHÂN -->
                <div class="form-left">
                    <!-- Personal Information Section -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-user"></i>
                            Thông tin cá nhân
                        </h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required" for="name">
                                    <i class="fas fa-user"></i>
                                    Họ và tên
                                </label>
                                <input
                                        class="form-input"
                                        id="name"
                                        maxlength="100"
                                        placeholder="Nhập họ và tên đầy đủ"
                                        required
                                        th:field="*{name}"
                                        type="text"
                                />
                                <div class="form-error" id="nameError"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required" for="email">
                                    <i class="fas fa-envelope"></i>
                                    Email
                                </label>
                                <input
                                        class="form-input"
                                        id="email"
                                        placeholder="example@hospital.com"
                                        required
                                        th:field="*{email}"
                                        type="email"
                                />
                                <div class="form-error" id="emailError"></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="password">
                                    <i class="fas fa-lock"></i>
                                    Mật khẩu
                                </label>
                                <input
                                        class="form-input"
                                        id="password"
                                        placeholder="Để trống nếu không muốn thay đổi"
                                        th:field="*{password}"
                                        type="password"
                                />
                                <div class="form-error" id="passwordError"></div>
                                <div class="form-help">Để trống nếu không muốn thay đổi mật khẩu</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="phone">
                                    <i class="fas fa-phone"></i>
                                    Số điện thoại
                                </label>
                                <input
                                        class="form-input"
                                        id="phone"
                                        pattern="[0-9]{10,11}"
                                        placeholder="0901234567"
                                        th:field="*{phone}"
                                        type="tel"
                                />
                                <div class="form-error" id="phoneError"></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="gender">
                                    <i class="fas fa-venus-mars"></i>
                                    Giới tính
                                </label>
                                <select class="form-select" id="gender" th:field="*{gender}">
                                    <option value="">-- Chọn giới tính --</option>
                                    <option value="true">Nam</option>
                                    <option value="false">Nữ</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="startingDate">
                                    <i class="fas fa-calendar-alt"></i>
                                    Ngày bắt đầu làm việc
                                </label>
                                <input
                                        class="form-input"
                                        id="startingDate"
                                        th:field="*{startingDate}"
                                        type="date"
                                />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="address">
                                <i class="fas fa-map-marker-alt"></i>
                                Địa chỉ
                            </label>
                            <textarea
                                    class="form-textarea"
                                    id="address"
                                    maxlength="200"
                                    placeholder="Nhập địa chỉ đầy đủ..."
                                    rows="3"
                                    th:field="*{address}"
                            ></textarea>
                            <div class="character-count">
                                <span id="addressCharCount">0</span>/200 ký tự
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CỘT PHẢI: THÔNG TIN CÔNG VIỆC + BỔ SUNG -->
                <div class="form-right">
                    <!-- Work Information Section -->
                    <!-- Work Information Section -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-briefcase"></i>
                            Thông tin công việc
                        </h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required" for="departmentId">
                                    <i class="fas fa-building"></i>
                                    Khoa
                                </label>
                                <select class="form-select" id="departmentId" required th:field="*{departmentId}">
                                    <option value="">-- Chọn khoa --</option>
                                    <option th:each="dept : ${departments}" th:text="${dept.name}"
                                            th:value="${dept.id}"></option>
                                </select>
                                <div class="form-error" id="departmentError"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required" for="positionId">
                                    <i class="fas fa-user-tie"></i>
                                    Chức vụ
                                </label>
                                <select class="form-select" id="positionId" required th:field="*{positionId}">
                                    <option value="">-- Chọn chức vụ --</option>
                                    <option th:each="pos : ${positions}" th:text="${pos.name}"
                                            th:value="${pos.id}"></option>
                                </select>
                                <div class="form-error" id="positionError"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="status">
                                <i class="fas fa-toggle-on"></i>
                                Trạng thái làm việc
                            </label>
                            <select class="form-select" id="status" th:field="*{status}">
                                <option value="true">Hoạt động</option>
                                <option value="false">Ngừng hoạt động</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">
                                <i class="fas fa-user-shield"></i>
                                Vai trò (có thể chọn nhiều)
                            </label>
                            <div class="roles-container">
                                <div class="role-item" th:each="role : ${roles}">
                                    <input
                                            th:field="*{roleIds}"
                                            th:id="'role_' + ${role.id}"
                                            th:value="${role.id}"
                                            type="checkbox"
                                    />
                                    <label class="role-label" th:for="'role_' + ${role.id}">
                                        <span th:text="${role.name}"></span>
                                        <small th:text="' (' + ${role.code} + ')'"></small>
                                    </label>
                                </div>
                            </div>
                            <div class="form-error" id="rolesError"></div>
                            <div class="form-help">Chọn các vai trò phù hợp với công việc của nhân viên</div>
                        </div>
                    </div>


                    <!-- Additional Information Section -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            Thông tin bổ sung
                        </h3>

                        <div class="form-group">
                            <label class="form-label" for="avatar">
                                <i class="fas fa-image"></i>
                                Avatar URL
                            </label>
                            <input
                                    class="form-input"
                                    id="avatar"
                                    placeholder="https://example.com/avatar.jpg"
                                    th:field="*{avatar}"
                                    type="text"
                            />
                            <div class="form-help">URL hình ảnh đại diện của nhân viên</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personal Information Section -->


            <!-- Form Actions -->
            <div class="form-actions">
                <button class="btn-secondary" onclick="history.back()" type="button">
                    <i class="fas fa-times"></i>
                    Hủy bỏ
                </button>
                <button class="btn-outline" type="reset">
                    <i class="fas fa-redo"></i>
                    Đặt lại
                </button>
                <button class="btn-primary" id="submitBtn" type="submit">
                    <i class="fas fa-save"></i>
                    <span>Cập nhật nhân viên</span>
                </button>
            </div>
        </form>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Sidebar menu interactions
        const menuItems = document.querySelectorAll(".menu-item");
        menuItems.forEach((item) => {
            item.addEventListener("click", function (e) {
                menuItems.forEach((mi) => mi.classList.remove("active"));
                this.classList.add("active");
            });
        });

        // Form validation and interactions
        const form = document.getElementById("employeeForm");
        const submitBtn = document.getElementById("submitBtn");

        // Character count for address
        const addressTextarea = document.getElementById("address");
        const addressCharCount = document.getElementById("addressCharCount");

        addressTextarea.addEventListener("input", function () {
            const count = this.value.length;
            addressCharCount.textContent = count;

            if (count > 180) {
                addressCharCount.style.color = "#dc3545";
            } else if (count > 150) {
                addressCharCount.style.color = "#ffc107";
            } else {
                addressCharCount.style.color = "#28a745";
            }
        });

        // Phone number formatting
        const phoneInput = document.getElementById("phone");
        phoneInput.addEventListener("input", function () {
            // Remove non-numeric characters
            this.value = this.value.replace(/\D/g, "");
        });

        // Avatar preview
        const avatarInput = document.getElementById("avatar");
        const avatarPreview = document.getElementById("avatarPreview");

        avatarInput.addEventListener("input", function () {
            const url = this.value.trim();
            if (url && isValidUrl(url)) {
                avatarPreview.src = url;
            }
        });

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // Form validation
        function validateForm() {
            let isValid = true;

            // Clear previous errors
            document.querySelectorAll(".form-error").forEach((error) => {
                error.textContent = "";
            });

            // Validate name
            const name = document.getElementById("name").value.trim();
            if (!name) {
                showError("nameError", "Tên nhân viên không được để trống");
                isValid = false;
            } else if (name.length < 2) {
                showError("nameError", "Tên nhân viên phải có ít nhất 2 ký tự");
                isValid = false;
            }

            // Validate email
            const email = document.getElementById("email").value.trim();
            if (!email) {
                showError("emailError", "Email không được để trống");
                isValid = false;
            } else if (!isValidEmail(email)) {
                showError("emailError", "Định dạng email không hợp lệ");
                isValid = false;
            }

            // Validate phone if provided
            const phone = phoneInput.value.trim();
            if (phone && (phone.length < 10 || phone.length > 11)) {
                showError("phoneError", "Số điện thoại phải có 10-11 chữ số");
                isValid = false;
            }

            // Validate department
            const department = document.getElementById("departmentId").value;
            if (!department) {
                showError("departmentError", "Vui lòng chọn khoa");
                isValid = false;
            }

            // Validate position
            const position = document.getElementById("positionId").value;
            if (!position) {
                showError("positionError", "Vui lòng chọn chức vụ");
                isValid = false;
            }

            // Validate roles
            const roles = document.querySelectorAll('input[name="roleIds"]:checked');
            if (roles.length === 0) {
                showError("rolesError", "Vui lòng chọn ít nhất một vai trò");
                isValid = false;
            }

            // Validate password if provided
            const password = document.getElementById("password").value;
            if (password && password.length < 6) {
                showError("passwordError", "Mật khẩu phải có ít nhất 6 ký tự");
                isValid = false;
            }

            return isValid;
        }

        function showError(elementId, message) {
            document.getElementById(elementId).textContent = message;
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Form submission
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            if (validateForm()) {
                // Show loading state
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang cập nhật...';
                submitBtn.disabled = true;

                // Simulate API call (replace with actual form submission)
                setTimeout(() => {
                    // Success message
                    showSuccessMessage();

                    // Reset button
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Cập nhật nhân viên';
                    submitBtn.disabled = false;

                    // Redirect after 2 seconds
                    setTimeout(() => {
                        window.location.href = "employees.html";
                    }, 2000);
                }, 1500);
            } else {
                // Scroll to first error
                const firstError = document.querySelector(".form-error:not(:empty)");
                if (firstError) {
                    firstError.scrollIntoView({
                        behavior: "smooth",
                        block: "center",
                    });
                }
            }
        });

        function showSuccessMessage() {
            // Create and show success notification
            const notification = document.createElement("div");
            notification.className = "success-notification";
            notification.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>Thông tin nhân viên đã được cập nhật thành công!</span>
          `;

            document.body.appendChild(notification);

            // Trigger animation
            setTimeout(() => {
                notification.classList.add("show");
            }, 100);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove("show");
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Real-time validation
        const inputs = form.querySelectorAll("input, select, textarea");
        inputs.forEach((input) => {
            input.addEventListener("blur", validateForm);
        });

        // Initialize character count
        addressTextarea.dispatchEvent(new Event("input"));
    });
</script>
</body>
</html>