<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Qu·∫£n l√Ω thu ng√¢n</title>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="container mt-5">

<h2 class="text-center">üîç Danh s√°ch h·ªì s∆° c·∫ßn thanh to√°n</h2>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3" id="recordTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="out-tab" data-bs-toggle="tab" data-bs-target="#outpatient" type="button" role="tab">Ngo·∫°i tr√∫</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="in-tab" data-bs-toggle="tab" data-bs-target="#inpatient" type="button" role="tab">N·ªôi tr√∫</button>
    </li>
</ul>

<div class="tab-content" id="recordTabsContent">
    <!-- Ngo·∫°i tr√∫ -->
    <div class="tab-pane fade show active" id="outpatient" role="tabpanel">
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>#</th>
                <th>M√£ h·ªì s∆°</th>
                <th>T√™n b·ªánh nh√¢n</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item, iter : ${records}">
                <td th:text="${iter.count}"></td>
                <td th:text="${item.code}"></td>
                <td th:text="${item.patientName}"></td>
                <td>
                    <button class="btn btn-info btn-sm btn-view-summary"
                            th:attr="data-id=${item.id}, data-inpatient=false">
                        Xem h√≥a ƒë∆°n
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- N·ªôi tr√∫ -->
    <div class="tab-pane fade" id="inpatient" role="tabpanel">
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>#</th>
                <th>M√£ h·ªì s∆°</th>
                <th>T√™n b·ªánh nh√¢n</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item, iter : ${records}">
                <td th:text="${iter.count}"></td>
                <td th:text="${item.code}"></td>
                <td th:text="${item.patientName}"></td>
                <td>
                    <button class="btn btn-info btn-sm btn-view-summary"
                            th:attr="data-id=${item.id}, data-inpatient=true">
                        Xem h√≥a ƒë∆°n
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ‚úÖ MODAL -->
<div class="modal fade" id="summaryModal" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" id="summary-container">
            <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load b·∫±ng Ajax -->
        </div>
    </div>
</div>

<!-- ‚úÖ JS -->
<script>
    // G·ªçi fragment chi ti·∫øt h√≥a ƒë∆°n
    function loadSummary(id, inpatient) {
        const url = inpatient
            ? '/cashier/inpatient/detail-fragment?id=' + id
            : '/cashier/detail-fragment?id=' + id;

        $('#summary-container').load(url, function (response, status) {
            if (status === "error") {
                $('#summary-container').html('<div class="p-3 alert alert-danger">Kh√¥ng th·ªÉ t·∫£i h√≥a ƒë∆°n.</div>');
            } else {
                const modal = new bootstrap.Modal(document.getElementById('summaryModal'));
                modal.show();

                formatVND(); // ‚úÖ Format sau khi load
            }
        });
    }

    // G√°n s·ª± ki·ªán click cho n√∫t "Xem h√≥a ƒë∆°n"
    $(document).on('click', '.btn-view-summary', function () {
        const id = $(this).data('id');
        const inpatient = $(this).data('inpatient');
        loadSummary(id, inpatient);
    });

    // G·ª≠i form thanh to√°n + t·∫£i PDF
    function submitPayment() {
        const form = document.getElementById("payForm");
        const formData = new FormData(form);

        fetch('/cashier/pay', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) throw new Error("Thanh to√°n th·∫•t b·∫°i");
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "hoa_don.pdf";
                document.body.appendChild(a);
                a.click();
                a.remove();

                // ƒê√≥ng modal v√† reload trang
                const modal = bootstrap.Modal.getInstance(document.getElementById('summaryModal'));
                modal.hide();

                location.reload();
            })
            .catch(error => {
                alert("L·ªói khi thanh to√°n: " + error.message);
            });
    }

    // H·ªßy modal
    function cancelModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('summaryModal'));
        modal.hide();
    }

    // ‚úÖ Format s·ªë ti·ªÅn th√†nh VND
    function formatVND() {
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
            minimumFractionDigits: 0
        });

        document.querySelectorAll('.vnd-format').forEach(el => {
            const value = parseInt(el.innerText);
            if (!isNaN(value)) {
                el.innerText = formatter.format(value);
            }
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
