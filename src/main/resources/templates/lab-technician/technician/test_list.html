<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{lab-technician/layout/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>Danh s√°ch phi·∫øu x√©t nghi·ªám</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: #f8f9fc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        h2 {
            color: #4e73df;
            font-weight: 600;
        }

        .btn {
            border-radius: 8px;
            font-weight: 500;
        }

        .table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }

        .table th {
            background-color: #f1f3f9;
        }

        .pagination .page-link {
            border-radius: 6px;
            color: #4e73df;
        }

        .pagination .active .page-link {
            background-color: #4e73df;
            border-color: #4e73df;
        }
    </style>
</head>
<body>
<main layout:fragment="main-content" class="container mt-4">

    <h2 class="mb-4">üìã Danh s√°ch Phi·∫øu X√©t Nghi·ªám Theo Ph√≤ng</h2>



    <!-- B·ªô l·ªçc lo·∫°i n·ªôi tr√∫ / ngo·∫°i tr√∫ -->
    <div class="mb-4">
        <a th:href="@{/lab-technician/room/{id}(id=${roomId}, type='inpatient')}"
           th:classappend="${type == 'inpatient'} ? 'btn-primary' : 'btn-outline-primary'"
           class="btn me-2">üè• N·ªôi tr√∫</a>
        <a th:href="@{/lab-technician/room/{id}(id=${roomId}, type='outpatient')}"
           th:classappend="${type == 'outpatient'} ? 'btn-success' : 'btn-outline-success'"
           class="btn">üßë‚Äç‚öïÔ∏è Ngo·∫°i tr√∫</a>
    </div>

    <!-- B·∫£ng -->
    <table class="table table-bordered table-striped align-middle">
        <thead>
        <tr>
            <th>STT</th>
            <th>B·ªánh nh√¢n</th>
            <th>M√£ h·ªì s∆°</th>
            <th>X√©t nghi·ªám</th>
            <th>Ghi ch√∫</th>
            <th>Tr·∫°ng th√°i</th>
            <th colspan="2" class="text-center">H√†nh ƒë·ªông</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="order,status : ${testOrderPage.content}">
            <td th:text="${status.count}"></td>
            <td th:text="${order.patientName}"></td>
            <td th:text="${order.medicalRecordCode}"></td>
            <td th:text="${order.name}"></td>
            <td th:text="${order.note} ?: '-'"></td>
            <td>
                <span th:if="${order.status == 'ƒê√£ ho√†n t·∫•t'}" class="badge bg-success">‚úÖ ƒê√£ ho√†n t·∫•t</span>
                <span th:if="${order.status == 'Ch∆∞a th·ª±c hi·ªán'}"
                      class="badge bg-warning text-dark">‚è≥ Ch∆∞a th·ª±c hi·ªán</span>
                <span th:if="${order.status == 'ƒê√£ h·ªßy'}" class="badge bg-danger">‚ùå ƒê√£ h·ªßy</span>
                <span th:if="${order.status != 'ƒê√£ ho√†n t·∫•t' and order.status != 'Ch∆∞a th·ª±c hi·ªán' and order.status != 'ƒê√£ h·ªßy'}"
                      class="badge bg-secondary" th:text="${order.status}"></span>
            </td>
            <td class="text-center">
                <!--        <a th:href="@{/lab-technician/input_result(testOrderId=${order.id}, roomId=${roomId}, type=${type})}"-->
                <!--           class="btn btn-sm btn-info">üëÅÔ∏è X√©t Nghi·ªám</a>-->

                <button type="button"
                        class="btn btn-sm btn-info"
                        data-bs-toggle="modal"
                        data-bs-target="#inputResultModal"
                        th:attr="data-order-id=${order.id},
                 data-room-id=${roomId},
                 data-type=${type}">
                    üëÅÔ∏è X√©t Nghi·ªám
                </button>
            </td>
            <td class="text-center">
                <a th:href="@{/lab-technician/patient_test/{id}(id=${order.patientId}, roomId=${roomId},type=${type})}"
                   class="btn btn-sm btn-info">üëÅÔ∏è Xem t·∫•t c·∫£</a>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Ph√¢n trang -->
    <nav>
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${testOrderPage.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/lab-technician/room/{id}(id=${roomId}, page=${testOrderPage.number - 1}, type=${type})}">‚óÄÔ∏è
                    Tr∆∞·ªõc</a>
            </li>
            <li th:each="i : ${#numbers.sequence(0, testOrderPage.totalPages - 1)}"
                class="page-item" th:classappend="${i == testOrderPage.number} ? 'active'">
                <a class="page-link"
                   th:href="@{/lab-technician/room/{id}(id=${roomId}, page=${i}, type=${type})}"
                   th:text="${i + 1}">1</a>
            </li>
            <li class="page-item" th:classappend="${testOrderPage.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/lab-technician/room/{id}(id=${roomId}, page=${testOrderPage.number + 1}, type=${type})}">Ti·∫øp
                    ‚ñ∂Ô∏è</a>
            </li>
        </ul>
    </nav>


    <!-- Modal nh·∫≠p k·∫øt qu·∫£ -->
    <div class="modal fade" id="inputResultModal" tabindex="-1" aria-labelledby="inputResultModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/lab-technician/upload-result}" method="post" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title" id="inputResultModalLabel">üß™ Nh·∫≠p k·∫øt qu·∫£ x√©t nghi·ªám</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                    </div>
                    <div class="modal-body">

                        <!-- Hidden fields ƒë·ªÉ g·ª≠i -->
                        <input type="hidden" name="testOrderId" id="modalTestOrderId">
                        <input type="hidden" name="roomId" id="modalRoomId">
                        <input type="hidden" name="type" id="modalType">

                        <div class="mb-3">
                            <label for="modalImage" class="form-label">·∫¢nh k·∫øt qu·∫£:</label>
                            <input type="file" class="form-control" name="image" id="modalImage" accept="image/*"
                                   required>
                        </div>

                        <div class="mb-3">
                            <label for="modalNote" class="form-label">Ghi ch√∫ k·∫øt qu·∫£:</label>
                            <textarea class="form-control" name="note" id="modalNote" rows="3" required></textarea>
                        </div>

                        <!-- Debug hi·ªÉn th·ªã ƒë·ªÉ ki·ªÉm tra -->
                        <div class="text-muted small">
                            <strong>Debug:</strong><br>
                            testOrderId: <span id="debugTestOrderId"></span><br>
                            roomId: <span id="debugRoomId"></span><br>
                            type: <span id="debugType"></span>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="submit" class="btn btn-success">üíæ L∆∞u k·∫øt qu·∫£</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Script x·ª≠ l√Ω modal -->
    <script>
        const inputModal = document.getElementById('inputResultModal');
        inputModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            if (!button) return;

            const orderId = button.getAttribute('data-order-id');
            const roomId = button.getAttribute('data-room-id');
            const type = button.getAttribute('data-type');

            document.getElementById('modalTestOrderId').value = orderId;
            document.getElementById('modalRoomId').value = roomId;
            document.getElementById('modalType').value = type;

            document.getElementById('debugTestOrderId').textContent = orderId;
            document.getElementById('debugRoomId').textContent = roomId;
            document.getElementById('debugType').textContent = type;

            console.log("‚úÖ Modal values:", {orderId, roomId, type});
        });

        // Ki·ªÉm tra testOrderId tr∆∞·ªõc khi submit
        document.querySelector('#inputResultModal form').addEventListener('submit', function (e) {
            const testOrderId = document.getElementById('modalTestOrderId').value;
            if (!testOrderId || testOrderId.trim() === '') {
                alert("‚ùå Thi·∫øu testOrderId. Kh√¥ng th·ªÉ g·ª≠i bi·ªÉu m·∫´u.");
                e.preventDefault();
            }
        });
    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
