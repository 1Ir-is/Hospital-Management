<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="/layout :: header">
    <title>View</title>
</head>
<body>
<div class="container mt-4">
    <main>
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-center">
                    <table class="table text-center w-50">
                        <thead class="table-info bg-success text-white">
                        <tr>
                            <th colspan="2">Thông tin bệnh nhân</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>Tên bệnh nhân:</td>
                            <td>
                                <p th:text="${test_orders.impatientRecord?.medicalRecord?.patient?.name}"></p>
                            </td>
                        </tr>
                        <tr>
                            <td>Mã bệnh nhân:</td>
                            <td>
                                <p th:text="${test_orders.impatientRecord?.medicalRecord?.patient?.id}"></p>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <hr>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Tên xét nghiệm</th>
                        <th scope="col">Bác sĩ xét nghiệm</th>
                        <th scope="col">Trạng thái</th>
                        <th scope="col"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="item, itemStatus: ${test_order}"
                        th:attr="data-result=${item.result}">
                        <th scope="row">
                            <p th:text="${itemStatus.count}"></p>
                        </th>
                        <td>
                            <p th:text="${item.test.name}"></p>
                        </td>
                        <td>
                            <p th:unless="${item.employee}">Trống</p>
                            <p th:if="${item.employee}" th:text="${item.employee?.name}"></p>
                        </td>
<!--                        <td>-->
                        <!--                            <button type="button"-->
                        <!--                                    th:attr="data-id=${item.id}, data-result=${item.result}"-->
                        <!--                                    class="btn btn-sm"-->
                        <!--                                    th:classappend="${item.status} ? 'btn-success' : 'btn-outline-warning'"-->
                        <!--                                    onclick="markAsCompleted(this)">-->
                        <!--                                <span th:if="${item.status}">Đã hoàn thành</span>-->
                        <!--                                <span th:unless="${item.status}">Đang chờ</span>-->
                        <!--                            </button>-->
                        <!--                        </td>-->
                                                <td>
                                                    <div class="p-0" th:if="${item.status}">
                                                        <span class="text-bg-success p-1">Đã hoàn thành</span>
                                                    </div>
                                                    <div th:unless="${item.status}">
                                                        <span class="text-bg-warning p-1">Đang chờ</span>
                                                    </div>
                                                </td>
<!--                        <td><a href="#" th:if="${item.status}" th:attr="data-result=${item.result}"-->
<!--                               onclick="showResult(this)"-->
<!--                               data-bs-target="#exampleModal" data-bs-toggle="modal">Kết quả</a></td>-->
                        <td>
                            <a th:if="${item.status}" th:href="@{/doctor/test-order/{id}/result(id=${item.id})}">
                                Kết quả
                            </a>
                        </td>

                    </tr>
                    </tbody>
                </table>
                <form th:action="@{/doctor/{id}/test/save(id=${test_order.impatientRecord != null ? test_order.impatientRecord.id : 0})}">
                    <div class="mb-3">
                        <label for="note" class="form-label">Kết luận của bác sĩ:</label>
                        <textarea name="note" id="note" class="form-control" rows="8"
                                  placeholder="Các kết luận..."></textarea>
                    </div>
                    <!--                    <button type="button" class="btn btn-success">Kê đơn thuốc</button>-->
                                        <button type="submit" class="btn btn-secondary">Hoàn tất</button>
                    <!--                    <button type="button" class="btn btn-danger">Cho nhập viện</button>-->
                    <a th:href="@{/doctor}" class="btn btn-outline-success">Quay lại</a>
                </form>
            </div>
        </div>
    </main>
    <!-- Modal -->
    <div class="modal fade " id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Kết quả xét nghiệm</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="result"></div>
                </div>
                <div class="modal-footer">
                    <!--                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>-->
                    <!--                <button type="button" class="btn btn-primary">Save changes</button>-->
                </div>
            </div>
        </div>
    </div>

    <script>
        function markAsCompleted(button) {
            const row = button.closest("tr");

            // Lấy kết quả từ attribute
            const result = button.getAttribute("data-result");

            // ✅ Cập nhật trạng thái hiển thị
            const statusCell = row.children[3]; // cột thứ 4 (index = 3)
            statusCell.innerHTML = `<span class="text-bg-success p-1">Đã hoàn thành</span>`;

            // ✅ Cập nhật ô chứa nút Kết quả (cột thứ 5)
           // const actionCell = row.children[4];
           // actionCell.innerHTML = `<a href="@{/doctor/test-order/{id}/result(id=${item.id})}" onclick="showResult(this)" data-result="${result}"
            //                      data-bs-toggle="modal" data-bs-target="#exampleModal">Kết quả</a>`;
        }

        function showResult(button) {
            const result = button.getAttribute("data-result");
            document.getElementById("result").innerText = result;
        }

    </script>

</div>
<footer th:replace="/layout :: footer"></footer>
</body>
