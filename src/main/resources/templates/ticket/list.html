<html lang="vi"
      layout:decorate="~{receptionist/layout/layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
<head>
    <meta charset="UTF-8">
    <title>Danh sách phiếu hôm nay</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }

        .called {
            color: green;
        }

        .waiting {
            color: red;
        }

        .highlight {
            background-color: #e0ffe0;
            animation: fadeOut 5s forwards;
        }

        @keyframes fadeOut {
            0% {
                background-color: #e0ffe0;
            }
            100% {
                background-color: transparent;
            }
        }
    </style>
</head>
<div layout:fragment="main-content">
    <h2>Danh sách phiếu hôm nay</h2>
    <div id="successAlert" th:if="${success}"
         class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4">
        <span th:text="${success}"></span>
    </div>
    <p th:if="${message}" th:text="${message}" style="color: green;"></p>

    <table>
        <thead>
        <tr>
            <th>Số thứ tự</th>
            <th>Họ tên</th>
            <th>Ưu tiên</th>
            <th>Thời gian đặt</th>
            <th>Trạng thái</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody id="ticketTableBody">
        <tr th:each="ticket : ${tickets}">
            <td th:text="${ticket.queueNumber}"></td>
            <td th:text="${ticket.name}"></td>
            <td th:text="${ticket.priority ? 'Ưu tiên' : 'Thường'}"></td>
            <td th:text="${#temporals.format(ticket.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
            <td th:text="${ticket.called ? 'Đã gọi' : 'Chờ gọi'}"
                th:classappend="${ticket.called ? 'called' : 'waiting'}"></td>
            <td>
                <form th:if="${!ticket.called}" th:action="@{/receptionist/call}" method="post">
                    <input type="hidden" name="ticketId" th:value="${ticket.id}"/>
                    <button type="submit">Gọi số</button>
                </form>
                <span th:if="${ticket.called}" style="color:gray;">✓</span>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- WebSocket Client Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            stompClient.subscribe('/topic/new-ticket', function (message) {
                const ticket = JSON.parse(message.body);
                const date = new Date(ticket.createdAt);
                const formattedDate = date.toLocaleDateString('vi-VN') + ' ' +
                    date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
                const row = document.createElement('tr');
                row.classList.add('highlight');

                row.innerHTML = `
                <td>${ticket.queueNumber}</td>
                <td>${ticket.name}</td>
                <td>${ticket.priority ? 'Ưu tiên' : 'Thường'}</td>
                <td>${formattedDate}</td>
                <td class="waiting">Chờ gọi</td>
                <td>
                    <form action="/receptionist/call" method="post">
                        <input type="hidden" name="ticketId" value="${ticket.id}" />
                        <button type="submit">Gọi số</button>
                    </form>
                </td>
            `;
                document.getElementById("ticketTableBody").insertBefore(row, document.getElementById("ticketTableBody").firstChild);
                row.scrollIntoView({behavior: 'smooth'}); // Cuộn xuống dòng vừa thêm

            });
        });
    </script>
    <script>
        // Tự động ẩn thông báo sau 3 giây
        window.addEventListener('DOMContentLoaded', () => {
            const successAlert = document.getElementById("successAlert");
            if (successAlert) {
                setTimeout(() => {
                    successAlert.style.display = "none";
                }, 3000);
            }
        });
    </script>

</div>


</html>
